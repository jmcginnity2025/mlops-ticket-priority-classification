# ML CI/CD Pipeline
# Triggers on every commit to main branch
# Trains model iterations and compares performance
# FAILS if new model performs worse than baseline

name: ML CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.9'

jobs:
  # Job 1: Data Preprocessing
  preprocess-data:
    name: Data Preprocessing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn joblib

    - name: Run preprocessing
      run: |
        python preprocess.py

    - name: Upload processed data
      uses: actions/upload-artifact@v4
      with:
        name: processed-data
        path: processed_data/
        retention-days: 7

  # Job 2: Train Models (Both Iterations)
  train-models:
    name: Train Model Iterations
    runs-on: ubuntu-latest
    needs: preprocess-data

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scikit-learn xgboost joblib

    - name: Download processed data
      uses: actions/download-artifact@v4
      with:
        name: processed-data
        path: processed_data/

    - name: Train Iteration 1 (Baseline)
      run: |
        echo "Training Iteration 1: Baseline Model"
        python train.py --iteration 1

    - name: Train Iteration 2 (Improved)
      run: |
        echo "Training Iteration 2: Improved Model"
        python train.py --iteration 2

    - name: Upload trained models
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: models/
        retention-days: 30

  # Job 3: Evaluate & Compare Models (REGRESSION TEST)
  evaluate-models:
    name: Evaluate & Regression Test
    runs-on: ubuntu-latest
    needs: train-models

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Download trained models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/

    - name: Run evaluation and regression testing
      id: evaluation
      run: |
        echo "Running model evaluation..."
        python evaluate.py
      continue-on-error: false  # Pipeline MUST fail if evaluation fails

    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: evaluation-results
        path: evaluation_results/

    - name: Display results
      if: always()
      run: |
        echo "==================================="
        echo "EVALUATION RESULTS"
        echo "==================================="
        if [ -f evaluation_results/evaluation_report.json ]; then
          cat evaluation_results/evaluation_report.json
        fi

  # Job 4: Version Models (Only if evaluation passed)
  version-models:
    name: Version & Tag Models
    runs-on: ubuntu-latest
    needs: evaluate-models

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/

    - name: Download evaluation results
      uses: actions/download-artifact@v4
      with:
        name: evaluation-results
        path: evaluation_results/

    - name: Create model version tag
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        echo "MODEL_VERSION=v_${TIMESTAMP}" >> $GITHUB_ENV
        echo "Created version tag: v_${TIMESTAMP}"

    - name: Generate pipeline summary
      run: |
        echo "### ML Pipeline Results :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ env.MODEL_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Model Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Data preprocessing completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Model training completed (2 iterations)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Regression testing passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Models versioned: ${{ env.MODEL_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Models are ready for deployment" >> $GITHUB_STEP_SUMMARY
        echo "- Download artifacts to deploy to Azure ML" >> $GITHUB_STEP_SUMMARY

    - name: Success notification
      run: |
        echo "================================================"
        echo "ðŸŽ‰ PIPELINE SUCCESSFUL!"
        echo "================================================"
        echo "All models passed regression testing"
        echo "Version: ${{ env.MODEL_VERSION }}"
        echo "================================================"
