# GitHub Actions CI/CD Pipeline for MLOps
name: MLOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests
      run: |
        pytest tests/ --junitxml=junit/test-results.xml --cov=src --cov-report=xml --cov-report=html

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: junit/test-results.xml

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/

  data-validation:
    name: Data Validation
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Validate data
      run: |
        python tests/test_data_validation.py

  train-model:
    name: Train and Evaluate Model
    runs-on: ubuntu-latest
    needs: data-validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Preprocess data
      run: |
        python src/data_preprocessing.py

    - name: Train model
      run: |
        python src/train_model.py --model_type multiclass --iterations 2

    - name: Evaluate model
      run: |
        python src/evaluate_model.py --model_type multiclass

    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: models/

    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results
        path: evaluation_results/

  validate-model:
    name: Validate Model Performance
    runs-on: ubuntu-latest
    needs: train-model

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download evaluation results
      uses: actions/download-artifact@v4
      with:
        name: evaluation-results
        path: evaluation_results/

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run performance tests
      run: |
        python tests/test_model_performance.py

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate-model
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.endpoint-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download model artifacts
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Register model
      run: |
        python src/deploy_model.py --action register --model_path models/multiclass_iteration_2/model.pkl --model_name ticket-priority-classifier

    - name: Deploy to staging
      id: deploy
      run: |
        python src/deploy_model.py --action deploy --model_name ticket-priority-classifier --endpoint_name ticket-priority-staging

    - name: Test staging deployment
      run: |
        python src/deploy_model.py --action test --endpoint_name ticket-priority-staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: ${{ steps.deploy.outputs.endpoint-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to production
      id: deploy
      run: |
        python src/deploy_model.py --action deploy --model_name ticket-priority-classifier --endpoint_name ticket-priority-production

    - name: Test production deployment
      run: |
        python src/deploy_model.py --action test --endpoint_name ticket-priority-production

    - name: Create deployment summary
      run: |
        echo "### Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "- Model: ticket-priority-classifier" >> $GITHUB_STEP_SUMMARY
        echo "- Environment: Production" >> $GITHUB_STEP_SUMMARY
        echo "- Status: Deployed" >> $GITHUB_STEP_SUMMARY
